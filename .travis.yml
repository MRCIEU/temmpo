language: python

python:
  - '2.7'

before_install:
  # Move source code to a directory structure the application expects.
  - mkdir -p lib/test/src/temmpo
  - shopt -s extglob
  - mv !(lib) lib/test/src/temmpo/
  - cd lib/test/src/temmpo/temmpo/settings/
  - ln -s travis_ci_private_settings.py private_settings.py
  - pwd
  - ls
  - cd $TRAVIS_BUILD_DIR
  - mkdir -p var/abstracts
  - mkdir -p var/data
  - mkdir -p var/log
  - mkdir -p var/results/testing/v1
  - mkdir -p var/results/testing/v3

install:
  - cd $TRAVIS_BUILD_DIR
  - cd lib/test/src/temmpo
  - pip install -U pip==19.1.1
  - pip install -U setuptools==44.1.0
  - pip install pip-tools==4.5.1
  - pip freeze
  - pip install -r requirements/requirements.txt
  - pip-sync requirements/test.txt

services:
  - mysql
  - redis-server

script:
  - cd $TRAVIS_BUILD_DIR
  - cd lib/test/src/temmpo
  - coverage run --source='.' manage.py test --settings=temmpo.settings.test_mysql --exclude-tag=selenium-test
  - coverage report --skip-empty --skip-covered -m
  # NB: When deployed Fabric is installed at a system packages level and supports the CI/CD pipeline
  - pip install fabric==1.13.1
  - fab -l -f deploy/fabfile.py

after_success:
  # Update requirements third party dependenacy checking service
  - test $TRAVIS_BRANCH = "TMMA-93" && requires.io update-branch -t $REQUIRES_IO_TOKEN -r rit/temmpo -n $TRAVIS_BRANCH requirements/

branches:
  only:
  - master
  - /^TMMA-.*$/

env:
  global:
    secure: KBzC8tsNjHQev6mVDZwZsosj/hpihdTRSvNI5n2h7chXHo02IGWDJXOCeWy0GPylcRC6tKW6W/YKSppgPqy2YiSwX9tdUWvlnzUVx8RmEJPYcz7XY21+uZ1D0Axh6WmT9Pg2wNIk6BTCzvCqqmiKDGZAhnd70xHPOI6lf+iNRVZA3k0bhCS9kpCP+HglThDMjGRXFvNtoGrtubw7/ZtlGM7DiS1b6RF0tFDh8IaCWZI3KEb8npdqkjvcMjkM6++CbO6+ScB6VxXVJkVZzEvICoGnWD72IITDG/A+ecWM+0NRU+mYuCe9FkbRoFd4GMLu5ODbtrW0L7ikhlDQhN+IBL08YVOf7sYx7xp0grT1oztQFEm3dSud4zbJDUkDTd0FlBdI3pebZqtN3EgURfCm0NTxHRrwuer2Ub7Isdgxe/vXddqP6pIRWJQzAkPoGiT62aqnDSjRD9w8P0tgpY/8dL+5vlSXYV3ErZzgKAzlZA2jK7z8s6+HPFkk8dTZK+O0PSSlvJ7AOsMdydamt7jLn49vD/ndALmv1u2yzXj/+jOOXU2zA6GgWPSbBLfQVsW4iof/YSIGifXDawluYwl1XPzU1ICF33DvNf/2V9f6CnngR2fI5oj0JRTpQ2Ve7/sliVgsIM8CmRDu6wVae2qPUkn+7K8/zDazcMKRwvIQIQA=
