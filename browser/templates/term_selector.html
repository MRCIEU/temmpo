{% extends "threecolumn.html" %}
{% load mptt_tags %}

{% block title %}TeMMPo: Select {{ type }} MeSH® terms{% endblock %}

{% block scripts %}
<!-- jstree -->
<script src="{{ STATIC_URL }}js/jstree/jstree.min.js"></script>
<script>
  $(function() {
    var availableTags = [
      "ActionScript",
      "AppleScript",
      "Asp",
      "BASIC",
      "C",
      "C++",
      "Clojure",
      "COBOL",
      "ColdFusion",
      "Erlang",
      "Fortran",
      "Groovy",
      "Haskell",
      "Human",
      "Java",
      "JavaScript",
      "Lisp",
      "Perl",
      "PHP",
      "Python",
      "Ruby",
      "Scala",
      "Scheme"
    ];
    $( "#tags" ).autocomplete({
      source: availableTags
    });
  });
</script>

{% endblock %}

{% block styles %}
<!-- jsTree -->
<link rel="stylesheet" href="{{ STATIC_URL }}css/jstree/themes/default/style.min.css" />
{% endblock %}

{% block page-heading %}
<h1>{{ form_title }}</h1>
{% endblock %}

{% block left-column %}
  <section>
    <h2>Quick search</h2>

    {# TODO wire up search by term name form #}
    <form action="." method="post">
        {% csrf_token %}
        <label for="tags">Term</label>
        <input id="tags" name="tags" type="text" value="" disabled />

        {# TODO display form fields properly #}

        <button type="submit" disabled>Add</button>
    </form>
  </section>

    {% if pre_selected_term_names %}
    <section>
      <h2>Current {{ type|lower }} terms</h2>
      <p>{{ pre_selected_term_names }}</p>
      {# TODO Improve mechanism for moving through workflow #}
      <a href="{{ next_url }}" class="button">Select {{ next_type }}</a>
  </section>
    {% endif %}
  
{% endblock %}

{% block middle-column %}
    <h2>MeSH® trees</h2>

    <!-- Mesh Term tree families -->
    <ul id="tree-family">
        {% for node in root_nodes %}
            <li>
                {% if selected_tree_root_node and node == selected_tree_root_node %}
                  <strong>{{ node.term }}</strong>
                {% else %}
                  <a href="{% url term_selector_by_family_url pk=form.instance.id tree_number=node.tree_number %}">{{ node.term }}</a>
                {% endif %}
            </li>
        {% endfor %}
    </ul>
{% endblock %}

{% block right-column %}

    {% if selected_tree_root_node %}
      <h2>Select {{ selected_tree_root_node }} <abbr title="Medical Subject Headings">MeSH®</abbr> terms</h2>

      <form action="." method="post">
          {% csrf_token %}

          {# form.as_p #} {# TODO: Wire up jquery tree (multi) select form widget #}

          <!-- div id="terms" data-url="{{ STATIC_URL }}js/mesh-sample.json"></div -->

          <!-- div id="terms"></div -->

          <!-- div id="xmlMenuTree"></div>
          <script type="text/javascript">
              $(document).ready(function(){
                  var options = {
                      xmlUrl: '{{ STATIC_URL }}menuTree.xml',
                      treePanelId: 'terms',
                      loadingText: 'Loading...',
                      loadingError: 'Error: Loading Error.',
                      initialExpanded: true,
                      toggleSpeed: 400,
                      storeState: true
                  };
                  $('#xmlMenuTree').xmltree(options);
              });
          </script -->
          <!-- js tree -->
          <div id="term_tree">
              <ul>
                  {% recursetree nodes %}
                      <li id="mtid_{{ node.id }}">
                          {{ node.term }}
                          {% if not node.is_leaf_node %}
                              <ul class="children">
                                  {{ children }}
                              </ul>
                          {% endif %}
                      </li>
                  {% endrecursetree %}
              </ul>

          </div>
          <script>
          $(function () { $('#term_tree').jstree(
              {"plugins" : [ "checkbox" ],  //"wholerow",
               "core" :
                  { 'multiple': true }
              }
              ); });
          // See: Ajax and JSON versions http://www.jstree.com/docs/json/
          // plugins http://www.jstree.com/plugins/
          </script>
          <button type="submit" name="btn_submit" value="choose" class="sml-button button">Select these terms and choose more {{ type }} terms</button>
          <button type="submit" name="btn_submit" value="progress" class="sml-button button">Select these terms and move on to select {{ next_type }}</button>
          <!-- <script>
          $('#terms').tree();

          $('#terms').tree({
               data: data
          });

          </script -->
          <input type="hidden" name="term_data" id="term_data" value="{{ pre_selected }}" />
          <input type="hidden" name="selected_tree_root_node_id" id="selected_tree_root_node_id" value="{{ selected_tree_root_node_id }}" />
      </form>
      <script src="{{ STATIC_URL }}js/tree_handler.js"></script>
      <script async type="text/javascript">
      $( document ).ready(function() {
          // Open all
          var pre_selected = "{{ pre_selected }}";
          var pre_sel_list = pre_selected.split(",");

          pre_sel_list.map( function(item) {
              var node = '#' + item;
              // Open the node
              $('#term_tree').jstree(true).check_node(node);
          })
      });
      </script>

    {% else %}
        <h2>No tree family selected</h2>
        <p>Select a Mesh Tree family to explore.<p>

    {% endif %}
{% endblock %}
