{% extends "onecolumncompact.html" %}

{% block title %}TeMMPo: Results{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ STATIC_URL}}js/jquery-ui-1.12.1/jquery-ui.min.css">
{% endblock %}

{% block body_class_style %}results-page{% endblock %}

{% block section_title %}
Results
{% endblock %}

{% block page_heading %}
    {% if search_result.mesh_filter %}
      <p>Results filtered by <strong>{{ search_result.mesh_filter }}</strong> MeSH® term.</p>
    {% endif %}

    <div id="threshold-controller">
        <p>
            <label for="chart-slider-label">Top matches:</label> <input type="text" id="chart-slider-label" readonly>
        </p>
        <div id="slider"></div>
    </div>
    <div id="results-buttons" class="form-group">
        <a href="{{ csv_url }}" class="btn btn-outline btn-default">Download as CSV</a> <a href="{{ criteria_url }}" class="btn btn-outline btn-default">View search criteria</a>
    </div>

{% endblock %}

{% block section %}
{# TODO: Should this be included somewhere? #}
<!--
<p>
Total {{ article_count }} papers.
</p>
-->
<div id="sankey_multiple"></div>
<hr /> {# TODO: Need to show and hide each chart type #}
<div id="bubble_chart"></div>
{% endblock %}

{% block scripts %}
    {# Chart related JS libraries #}
    <script src="{{ STATIC_URL}}js/d3.min.js"></script>
    <script src="{{ STATIC_URL}}js/jquery-ui-1.12.1/jquery-ui.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        // Generate Sankey diagram
        google.charts.load("44", {packages: ["sankey"]});
        google.charts.setOnLoadCallback(function() { (getLinks(topVal))});

        function getAllIndexes(arr, val) {
            var indexes = [], i = -1;
            while ((i = arr.indexOf(val, i + 1)) != -1) {
                indexes.push(i);
            }
            return indexes;
        }

        topVal = 50
        function getLinks(topVal) {
            var threshold = topVal;
            var exp_int = [];
            var int_out = [];
            var oLinks = [];
            var sData = [];
            d3.json("{{ json_url }}", function (matches) {
                //create arrays of target and sources
                matches.links = matches.links.filter(function (link) {
                    exp_int.push(link.target);
                    int_out.push(link.source);
                    return link;
                })
                //find overlapping link objects
                for (i in exp_int) {
                    var int_out_match = int_out.indexOf(exp_int[i]);
                    var indexes = getAllIndexes(int_out, exp_int[i]);
                    if (indexes.length > 0) {
                        for (j in indexes) {
                            var o = {oNode: exp_int[i], l1: parseInt(i), l2: indexes[j]};
                            oLinks.push(o);
                        }
                    }
                }
                //calculate scores based on number of abstracts for overlapping links
                for (i in oLinks) {
                    var l1_val = matches.links[oLinks[i].l1].value;
                    var l2_val = matches.links[oLinks[i].l2].value;
                    if (l1_val > l2_val) {
                        var score = l2_val / l1_val * (l1_val + l2_val);
                    } else {
                        var score = l1_val / l2_val * (l1_val + l2_val);
                    }
                    oLinks[i].score = score;
                }

                // //sort the objects by score
                var oLinksSort = oLinks.sort(function (a, b) {
                    return b.score - a.score;
                })

                if (threshold != -1 && oLinksSort.length > threshold) {
                    console.log("Limiting links to " + threshold + " instead of showing " + oLinksSort.length);
                    topLinks = oLinksSort.slice(0, threshold);
                }
                else
                {
                    topLinks = oLinksSort;
                }

                var top_sources = [];
                var top_targets = [];
                for (i in topLinks) {
                    t1 = matches.links[topLinks[i].l1].target;
                    s1 = matches.links[topLinks[i].l1].source;
                    t2 = matches.links[topLinks[i].l2].target;
                    s2 = matches.links[topLinks[i].l2].source;
                    top_sources.push(s1, s2);
                    top_targets.push(t1, t2);
                }
                nodeMatch = []

                matches.links = matches.links.filter(function (link) {
                    if (top_targets.indexOf(link.target) > -1 && top_sources.indexOf(link.source) > -1) {
                        nodeMatch.push(link.target, link.source);
                        target = matches.nodes[link.target].name;
                        source = matches.nodes[link.source].name;
                        sData.push([source, target, link.value]);
                    }
                });
                // Hide the slider if we are not limiting the result set
                if (topLinks.length < 5) {
                    $("#threshold-controller").hide();
                }

                drawSankeyDiagram(sData);
            })
        }

        function drawSankeyDiagram(sData) {
            var data = new google.visualization.DataTable();
            var s1Name = 'a'
            var s2Name = 'b'
            var maxCounter = 0

            data.addColumn('string', 'From');
            data.addColumn('string', 'To');
            data.addColumn('number', 'Articles');
            data.addRows(sData)

            // Set chart options
            var options = {
                width: 1200,
                height: 650,
                sankey: {
                    node: {
                        interactivity: true,
                        label: {
                            fontName: '"Helvetica Neue",Helvetica,Arial,sans-serif',
                            fontSize: 12,
                        }
                    }
                }
            };

            // Instantiate and draw our chart, passing in some options.
            var chart = new google.visualization.Sankey(document.getElementById('sankey_multiple'));
            chart.draw(data, options);

        }
        $(document).ready(function () {

            $(function () {
                $("#slider").slider({
                    range: "max",
                    min: 5,
                    max: 500,
                    value: 50,
                    slide: function (event, ui) {
                        $("#chart-slider-label").val(ui.value);
                        google.charts.setOnLoadCallback(function() { (getLinks(ui.value))});
                    }
                });
                $("#chart-slider-label").val($("#slider").slider("value"));
            });
        })
    </script>
    <script>
        // Generate Bubble chart
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(loadBubbleChartData);

        function loadBubbleChartData() {
          var max_results = 20;
          var data = new google.visualization.DataTable();
          data.addColumn('string', 'ID');
          data.addColumn('number', 'Number of abstracts linking exposure to mechanism');
          data.addColumn('number', 'Number of abstracts linking exposure to outcome');
          data.addColumn('string', 'Mechanism');
          data.addColumn('number', 'Score');
          d3.csv("{{ csv_url }}", function(score_data) {
            // Only use the top results
            if (score_data.length > max_results) {
              score_data = score_data.slice(0, max_results)
            }
            for (var i = 0; i < score_data.length; i++) {
              id = String(i+1);
              data.addRow([id, Number(score_data[i]["Exposure counts"]), Number(score_data[i]["Outcome counts"]), id + ". " + score_data[i]['Mediators'], Number(score_data[i]['Scores'])]);
            }

            drawBubbleChart(data);
          });
        }

        function drawBubbleChart(data) {
          var options = {
            title: 'Focused search results from PubMed based on original score (Top 20)',
            hAxis: { title: 'Number of abstracts linking exposure to mechanism',
                     titleTextStyle: { bold: true }
            },
            vAxis: { title: 'Number of abstracts linking exposure to outcome',
                     titleTextStyle: { bold: true }
            },
            bubble: { textStyle: 
                      { fontSize: 12,
                        fontName: '"Helvetica Neue",Helvetica,Arial,sans-serif',
                        auraColor: 'none',
                        color: 'white',
                        bold: true
                      },
            },
            chartArea: {width:'75%' }
          };
          var chart = new google.visualization.BubbleChart(document.getElementById('bubble_chart'));
          chart.draw(data, options);
        }
    </script>
{% endblock %}
