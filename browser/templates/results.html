{% extends "onecolumncompact.html" %}

{% block title %}TeMMPo: Results{% endblock %}

{% block styles %}
<style>
  {# TODO: Add this to override -1px in style.css #}
  body{
      letter-spacing: 0px;
  }
</style>
{% endblock %}

{% block section_title %}
Results
{% endblock %}

{% block page_heading %}
<p>
    {% if search_result.mesh_filter %}
      Results filtered by <strong>{{ search_result.mesh_filter }}</strong> MeSHÂ® term and limited to the top 50 matches.
    {% else %}
        <p>
          <label for="min">Top matches:</label>
          <input type="text" id="min" readonly style="font-size:large; border:0; color:#f6931f; font-weight:bold;">
        </p>
        <div id="topMatch"></div>
    {% endif %}

    <a href="{{ csv_url }}" class="btn btn-outline btn-default">Download as CSV</a> <a href="{{ criteria_url }}" class="btn btn-outline btn-default">View associated search criteria</a>
</p>
{% endblock %}

{% block section %}
<!--
<p>
Total {{ article_count }} papers containing mediators AND the MeSH term <strong>{{ mesh_term_filter }}</strong>.
</p>
-->
{# TODO Consider using 960px as the height #}
<div style="margin: auto; width:100%; height: 500px;" id="sankey_multiple"></div>
{% endblock %}

{% block scripts %}
    {# Chart related JS #}
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="{{ STATIC_URL}}js/d3.min.js"></script>
    <!-- script src="{{ STATIC_URL}}js/sankey.js"></script -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load("44", {packages: ["sankey"]});
        google.charts.setOnLoadCallback(function() { (getLinks(topVal))});
    </script>
    <script>
    function getAllIndexes(arr, val) {
            var indexes = [], i = -1;
            while ((i = arr.indexOf(val, i + 1)) != -1) {
                indexes.push(i);
            }
            return indexes;
        }

        topVal = 20
        function getLinks(topVal) {
            var threshold = topVal;
            var scoreSort = {}
            var exp_int = []
            var int_out = []
            var oLinks = []
            var sData = []
            d3.json("{{ json_url }}", function (matches) {
                if (threshold != -1 && matches.links.length > threshold) {
                    //create arrays of target and sources
                    matches.links = matches.links.filter(function (link) {
                        exp_int.push(link.target)
                        int_out.push(link.source)
                        return link
                    })
                    //find overlapping link objects
                    for (i in exp_int) {
                        var int_out_match = int_out.indexOf(exp_int[i])
                        var indexes = getAllIndexes(int_out, exp_int[i])
                        if (indexes.length > 0) {
                            for (j in indexes) {
                                var o = {oNode: exp_int[i], l1: parseInt(i), l2: indexes[j]}
                                oLinks.push(o)
                            }
                        }
                    }
                    //calculate scores based on number of abstracts for overlapping links
                    for (i in oLinks) {
                        var l1_val = matches.links[oLinks[i].l1].value
                        var l2_val = matches.links[oLinks[i].l2].value
                        if (l1_val > l2_val) {
                            var score = l2_val / l1_val * (l1_val + l2_val)
                        } else {
                            var score = l1_val / l2_val * (l1_val + l2_val)
                        }
                        oLinks[i].score = score
                    }
                    //sort the objects by score
                    var oLinksSort = oLinks.sort(function (a, b) {
                        return b.score - a.score
                    })

                    console.log("Limiting matches to " + threshold + " instead of showing " + matches.links.length);

                    topLinks = oLinksSort.slice(0, threshold);

                    var top_sources = []
                    var top_targets = []
                    for (i in topLinks) {
                        t1 = matches.links[topLinks[i].l1].target
                        s1 = matches.links[topLinks[i].l1].source
                        t2 = matches.links[topLinks[i].l2].target
                        s2 = matches.links[topLinks[i].l2].source
                        top_sources.push(s1, s2)
                        top_targets.push(t1, t2)
                    }
                    nodeMatch = []

                    matches.links = matches.links.filter(function (link) {
                        if (top_targets.indexOf(link.target) > -1 && top_sources.indexOf(link.source) > -1) {
                            nodeMatch.push(link.target, link.source)
                            target = matches.nodes[link.target].name
                            source = matches.nodes[link.source].name
                            sData.push([source, target, link.value])
                        }
                    });
                    drawChart(sData)
                }
            })

        }

        function drawChart(sData) {
            var data = new google.visualization.DataTable();
            var s1Name = 'a'
            var s2Name = 'b'
            var maxCounter = 0

            data.addColumn('string', 'From');
            data.addColumn('string', 'To');
            data.addColumn('number', 'Articles');
            data.addRows(sData)

            // Set chart options
            var options = {
                width: 1200,
                height: 500,
                //iterations: 100,
                //sankey: { node: { nodePadding: 10 } },
                sankey: {
                    node: {
                        interactivity: true,
                        label: {
                            fontName: 'Times-Roman',
                            fontSize: 12,
                            //color: '#871b47',
                            //bold: true,
                            //italic: true
                        }
                    }
                }
            };

            // Instantiate and draw our chart, passing in some options.
            var chart = new google.visualization.Sankey(document.getElementById('sankey_multiple'));
            chart.draw(data, options);

        }
        $(document).ready(function () {

            $(function () {

                $("#topMatch").slider({
                    range: "max",
                    min: 5,
                    max: 100,
                    value: 20,
                    slide: function (event, ui) {
                        $("#min").val(ui.value);
                        google.charts.setOnLoadCallback(function() { (getLinks(ui.value))});
                    }
                });
                $("#min").val($("#topMatch").slider("value"));
            });
        })
    </script>
{% endblock %}
